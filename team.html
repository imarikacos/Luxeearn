<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Dashboard - Referral System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }
    
    .dark .skeleton {
      background: linear-gradient(90deg, #2a2a2a 25%, #1a1a1a 50%, #2a2a2a 75%);
      background-size: 200% 100%;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .rotate {
      animation: rotate 1s linear infinite;
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .card-hover {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .accordion-content.open {
      max-height: 2000px;
    }

    .chevron {
      transition: transform 0.3s ease;
    }

    .chevron.open {
      transform: rotate(180deg);
    }
  </style>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#3b82f6',
              foreground: '#ffffff',
            },
            destructive: {
              DEFAULT: '#ef4444',
              foreground: '#ffffff',
            },
          }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
  
  <div id="toast-container"></div>
  
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-8">
    
    <header class="mb-8 fade-in">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Team Dashboard</h1>
          <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="user-email">Loading...</p>
        </div>
        <div class="flex items-center gap-3">
          <button 
            onclick="refreshData()" 
            id="refresh-btn"
            class="inline-flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors text-sm font-medium text-gray-700 dark:text-gray-200"
            data-testid="button-refresh"
          >
            <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
              <path d="M3 3v5h5"></path>
              <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
              <path d="M16 16h5v5"></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 fade-in">
      
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700 card-hover">
        <div class="flex items-center gap-3 mb-2">
          <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600 dark:text-blue-400">
              <line x1="12" x2="12" y1="2" y2="22"></line>
              <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
          </div>
          <span class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide">Total Deposits</span>
        </div>
        <div id="total-deposits" class="text-2xl font-bold text-gray-900 dark:text-white">
          <div class="skeleton h-8 w-24 rounded"></div>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700 card-hover">
        <div class="flex items-center gap-3 mb-2">
          <div class="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600 dark:text-green-400">
              <path d="M3 3v18h18"></path>
              <path d="m19 9-5 5-4-4-3 3"></path>
            </svg>
          </div>
          <span class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide">Total Earnings</span>
        </div>
        <div id="total-earnings" class="text-2xl font-bold text-gray-900 dark:text-white">
          <div class="skeleton h-8 w-24 rounded"></div>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700 card-hover">
        <div class="flex items-center gap-3 mb-2">
          <div class="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-600 dark:text-purple-400">
              <path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6"></path>
              <path d="M12 2v10"></path>
              <path d="m7 9 5-5 5 5"></path>
            </svg>
          </div>
          <span class="text-sm font-medium text-gray-600 dark:text-gray-400 uppercase tracking-wide">Pending Rewards</span>
        </div>
        <div id="pending-rewards" class="text-2xl font-bold text-gray-900 dark:text-white">
          <div class="skeleton h-8 w-24 rounded"></div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 fade-in">
      
      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Referral Code</h2>
        <div id="referral-code-container">
          <div class="skeleton h-12 w-full rounded"></div>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-800 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">Referral Link</h2>
        <div id="referral-link-container">
          <div class="skeleton h-12 w-full rounded"></div>
        </div>
      </div>
    </div>

    <div id="rewards-bar-container" class="hidden mb-8 fade-in">
      <div class="bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900/20 dark:to-blue-900/20 rounded-lg p-6 border border-purple-200 dark:border-purple-800">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">Rewards Available</h3>
            <p class="text-3xl font-bold text-purple-600 dark:text-purple-400" id="claimable-amount">$0.00</p>
          </div>
          <button 
            onclick="claimRewards()" 
            id="claim-btn"
            class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            data-testid="button-claim-rewards"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6"></path>
              <path d="M12 2v10"></path>
              <path d="m7 9 5-5 5 5"></path>
            </svg>
            <span id="claim-btn-text">Claim Rewards</span>
          </button>
        </div>
        <div class="mt-4 bg-white dark:bg-gray-700 rounded-full h-2 overflow-hidden">
          <div id="rewards-progress" class="h-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-500" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden fade-in">
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Team Referrals</h2>
      </div>
      
      <div id="team-levels-container">
        <div class="p-6">
          <div class="skeleton h-40 w-full rounded"></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const API_BASE = 'https://referralbackend-tn6h.onrender.com';
    let userData = null;
    let referralsData = [];
    let rewardsData = [];

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast p-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'} text-white`;
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'flex items-center gap-3';
      
      const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      iconSvg.setAttribute('width', '20');
      iconSvg.setAttribute('height', '20');
      iconSvg.setAttribute('viewBox', '0 0 24 24');
      iconSvg.setAttribute('fill', 'none');
      iconSvg.setAttribute('stroke', 'currentColor');
      iconSvg.setAttribute('stroke-width', '2');
      
      if (type === 'success') {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M20 6 9 17l-5-5');
        iconSvg.appendChild(path);
      } else {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', '12');
        circle.setAttribute('cy', '12');
        circle.setAttribute('r', '10');
        iconSvg.appendChild(circle);
        
        const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line1.setAttribute('x1', '12');
        line1.setAttribute('x2', '12');
        line1.setAttribute('y1', '8');
        line1.setAttribute('y2', '12');
        iconSvg.appendChild(line1);
        
        const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line2.setAttribute('x1', '12');
        line2.setAttribute('x2', '12.01');
        line2.setAttribute('y1', '16');
        line2.setAttribute('y2', '16');
        iconSvg.appendChild(line2);
      }
      
      const messageSpan = document.createElement('span');
      messageSpan.textContent = message;
      
      contentDiv.appendChild(iconSvg);
      contentDiv.appendChild(messageSpan);
      toast.appendChild(contentDiv);
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function copyToClipboard(text, label) {
      navigator.clipboard.writeText(text).then(() => {
        showToast(`${label} copied to clipboard!`, 'success');
      }).catch(() => {
        showToast('Failed to copy', 'error');
      });
    }

    function renderReferralCode(code) {
      const container = document.getElementById('referral-code-container');
      container.innerHTML = '';
      
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-center gap-2';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = code;
      input.readOnly = true;
      input.className = 'flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white font-mono text-lg';
      input.setAttribute('data-testid', 'input-referral-code');
      
      const button = document.createElement('button');
      button.className = 'px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors';
      button.setAttribute('data-testid', 'button-copy-code');
      button.onclick = () => copyToClipboard(code, 'Referral code');
      
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', '20');
      svg.setAttribute('height', '20');
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');
      svg.setAttribute('stroke', 'currentColor');
      svg.setAttribute('stroke-width', '2');
      
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('width', '14');
      rect.setAttribute('height', '14');
      rect.setAttribute('x', '8');
      rect.setAttribute('y', '8');
      rect.setAttribute('rx', '2');
      rect.setAttribute('ry', '2');
      
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2');
      
      svg.appendChild(rect);
      svg.appendChild(path);
      button.appendChild(svg);
      
      wrapper.appendChild(input);
      wrapper.appendChild(button);
      container.appendChild(wrapper);
    }

    function renderReferralLink(link) {
      const container = document.getElementById('referral-link-container');
      container.innerHTML = '';
      
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-center gap-2';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = link;
      input.readOnly = true;
      input.className = 'flex-1 px-4 py-3 bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white text-sm';
      input.setAttribute('data-testid', 'input-referral-link');
      
      const button = document.createElement('button');
      button.className = 'px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors';
      button.setAttribute('data-testid', 'button-copy-link');
      button.onclick = () => copyToClipboard(link, 'Referral link');
      
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', '20');
      svg.setAttribute('height', '20');
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', 'none');
      svg.setAttribute('stroke', 'currentColor');
      svg.setAttribute('stroke-width', '2');
      
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect.setAttribute('width', '14');
      rect.setAttribute('height', '14');
      rect.setAttribute('x', '8');
      rect.setAttribute('y', '8');
      rect.setAttribute('rx', '2');
      rect.setAttribute('ry', '2');
      
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', 'M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2');
      
      svg.appendChild(rect);
      svg.appendChild(path);
      button.appendChild(svg);
      
      wrapper.appendChild(input);
      wrapper.appendChild(button);
      container.appendChild(wrapper);
    }

    function toggleAccordion(levelNum) {
      const content = document.getElementById(`level-${levelNum}-content`);
      const chevron = document.getElementById(`level-${levelNum}-chevron`);
      
      content.classList.toggle('open');
      chevron.classList.toggle('open');
    }

    function renderTeamLevels() {
      const container = document.getElementById('team-levels-container');
      container.innerHTML = '';
      
      const level1 = referralsData.filter(r => r.level === 1);
      const level2 = referralsData.filter(r => r.level === 2);
      const level3 = referralsData.filter(r => r.level === 3);

      [
        { num: 1, data: level1 },
        { num: 2, data: level2 },
        { num: 3, data: level3 }
      ].forEach((level, index) => {
        const levelSection = document.createElement('div');
        levelSection.className = 'border-b border-gray-200 dark:border-gray-700 last:border-0';
        
        const header = document.createElement('div');
        header.className = 'p-6 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors';
        header.onclick = () => toggleAccordion(level.num);
        
        const headerContent = document.createElement('div');
        headerContent.className = 'flex items-center justify-between';
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'flex items-center gap-3';
        
        const title = document.createElement('h3');
        title.className = 'text-lg font-semibold text-gray-900 dark:text-white';
        title.textContent = `Level ${level.num}`;
        
        const badge = document.createElement('span');
        badge.className = level.data.length > 0 
          ? 'px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-full text-sm font-medium'
          : 'px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full text-sm font-medium';
        badge.textContent = `${level.data.length} referral${level.data.length !== 1 ? 's' : ''}`;
        
        const chevron = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        chevron.setAttribute('id', `level-${level.num}-chevron`);
        chevron.setAttribute('class', index === 0 ? 'chevron open' : 'chevron');
        chevron.setAttribute('width', '20');
        chevron.setAttribute('height', '20');
        chevron.setAttribute('viewBox', '0 0 24 24');
        chevron.setAttribute('fill', 'none');
        chevron.setAttribute('stroke', 'currentColor');
        chevron.setAttribute('stroke-width', '2');
        
        const chevronPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        chevronPath.setAttribute('d', 'm6 9 6 6 6-6');
        chevron.appendChild(chevronPath);
        chevron.classList.add('text-gray-500', 'dark:text-gray-400');
        
        titleDiv.appendChild(title);
        titleDiv.appendChild(badge);
        headerContent.appendChild(titleDiv);
        headerContent.appendChild(chevron);
        header.appendChild(headerContent);
        
        const content = document.createElement('div');
        content.id = `level-${level.num}-content`;
        content.className = index === 0 ? 'accordion-content open' : 'accordion-content';
        
        if (level.data.length === 0) {
          const emptyState = document.createElement('div');
          emptyState.className = 'px-6 pb-6';
          const emptyText = document.createElement('p');
          emptyText.className = 'text-gray-500 dark:text-gray-400 text-center py-8';
          emptyText.textContent = 'No referrals at this level yet';
          emptyState.appendChild(emptyText);
          content.appendChild(emptyState);
        } else {
          const tableWrapper = document.createElement('div');
          tableWrapper.className = 'px-6 pb-6 overflow-x-auto';
          
          const table = document.createElement('table');
          table.className = 'w-full';
          
          const thead = document.createElement('thead');
          thead.className = 'bg-gray-50 dark:bg-gray-700/50';
          
          const headerRow = document.createElement('tr');
          
          ['Email', 'Total Deposits', 'Date Joined'].forEach(headerText => {
            const th = document.createElement('th');
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider';
            th.textContent = headerText;
            headerRow.appendChild(th);
          });
          
          thead.appendChild(headerRow);
          table.appendChild(thead);
          
          const tbody = document.createElement('tbody');
          tbody.className = 'bg-white dark:bg-gray-800 divide-y divide-gray-100 dark:divide-gray-700';
          
          level.data.forEach((ref, idx) => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-100 dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors';
            tr.setAttribute('data-testid', `row-referral-${idx}`);
            
            const emailTd = document.createElement('td');
            emailTd.className = 'px-6 py-4 text-sm text-gray-900 dark:text-white';
            emailTd.textContent = ref.referred_email;
            
            const depositTd = document.createElement('td');
            depositTd.className = 'px-6 py-4 text-sm font-medium text-gray-900 dark:text-white';
            depositTd.textContent = `$${parseFloat(ref.total_deposits || 0).toFixed(2)}`;
            
            const dateTd = document.createElement('td');
            dateTd.className = 'px-6 py-4 text-sm text-gray-500 dark:text-gray-400';
            dateTd.textContent = new Date(ref.created_at).toLocaleDateString();
            
            tr.appendChild(emailTd);
            tr.appendChild(depositTd);
            tr.appendChild(dateTd);
            tbody.appendChild(tr);
          });
          
          table.appendChild(tbody);
          tableWrapper.appendChild(table);
          content.appendChild(tableWrapper);
        }
        
        levelSection.appendChild(header);
        levelSection.appendChild(content);
        container.appendChild(levelSection);
      });
    }

    async function fetchUserData() {
      const email = localStorage.getItem('email');
      
      if (!email) {
        showToast('No email found in localStorage. Please register first.', 'error');
        document.getElementById('user-email').textContent = 'Email not found';
        return;
      }

      document.getElementById('user-email').textContent = email;

      try {
        const response = await fetch(`${API_BASE}/api/user/${encodeURIComponent(email)}`);
        
        if (!response.ok) {
          throw new Error('Failed to fetch user data');
        }

        const data = await response.json();
        userData = data.user;
        referralsData = data.referrals || [];
        rewardsData = data.rewards || [];

        const totalDepositsSpan = document.createElement('span');
        totalDepositsSpan.setAttribute('data-testid', 'text-total-deposits');
        totalDepositsSpan.textContent = `$${parseFloat(userData.totalDeposits || 0).toFixed(2)}`;
        document.getElementById('total-deposits').innerHTML = '';
        document.getElementById('total-deposits').appendChild(totalDepositsSpan);

        const totalEarningsSpan = document.createElement('span');
        totalEarningsSpan.setAttribute('data-testid', 'text-total-earnings');
        totalEarningsSpan.textContent = `$${parseFloat(userData.totalEarnings || 0).toFixed(2)}`;
        document.getElementById('total-earnings').innerHTML = '';
        document.getElementById('total-earnings').appendChild(totalEarningsSpan);

        const pendingRewardsSpan = document.createElement('span');
        pendingRewardsSpan.setAttribute('data-testid', 'text-pending-rewards');
        pendingRewardsSpan.textContent = `$${parseFloat(userData.pendingRewards || 0).toFixed(2)}`;
        document.getElementById('pending-rewards').innerHTML = '';
        document.getElementById('pending-rewards').appendChild(pendingRewardsSpan);

        renderReferralCode(userData.referralCode);
        renderReferralLink(userData.referralLink);
        renderTeamLevels();

        const pendingAmount = parseFloat(userData.pendingRewards || 0);
        if (pendingAmount > 0) {
          document.getElementById('rewards-bar-container').classList.remove('hidden');
          document.getElementById('claimable-amount').textContent = `$${pendingAmount.toFixed(2)}`;
          document.getElementById('rewards-progress').style.width = '100%';
        } else {
          document.getElementById('rewards-bar-container').classList.add('hidden');
        }

      } catch (error) {
        console.error('Error fetching user data:', error);
        showToast('Failed to load data. The server might be sleeping. Click refresh to try again.', 'error');
        
        document.getElementById('total-deposits').textContent = 'Error';
        document.getElementById('total-deposits').classList.add('text-red-500');
        document.getElementById('total-earnings').textContent = 'Error';
        document.getElementById('total-earnings').classList.add('text-red-500');
        document.getElementById('pending-rewards').textContent = 'Error';
        document.getElementById('pending-rewards').classList.add('text-red-500');
        
        const codeContainer = document.getElementById('referral-code-container');
        codeContainer.innerHTML = '';
        const codeError = document.createElement('div');
        codeError.className = 'text-center py-4 text-gray-500 dark:text-gray-400';
        const codeErrorText = document.createElement('p');
        codeErrorText.textContent = 'Failed to load referral code';
        const codeRetryBtn = document.createElement('button');
        codeRetryBtn.className = 'mt-2 text-blue-600 dark:text-blue-400 hover:underline';
        codeRetryBtn.textContent = 'Try again';
        codeRetryBtn.onclick = refreshData;
        codeError.appendChild(codeErrorText);
        codeError.appendChild(codeRetryBtn);
        codeContainer.appendChild(codeError);
        
        const linkContainer = document.getElementById('referral-link-container');
        linkContainer.innerHTML = '';
        const linkError = document.createElement('div');
        linkError.className = 'text-center py-4 text-gray-500 dark:text-gray-400';
        const linkErrorText = document.createElement('p');
        linkErrorText.textContent = 'Failed to load referral link';
        const linkRetryBtn = document.createElement('button');
        linkRetryBtn.className = 'mt-2 text-blue-600 dark:text-blue-400 hover:underline';
        linkRetryBtn.textContent = 'Try again';
        linkRetryBtn.onclick = refreshData;
        linkError.appendChild(linkErrorText);
        linkError.appendChild(linkRetryBtn);
        linkContainer.appendChild(linkError);
        
        const teamContainer = document.getElementById('team-levels-container');
        teamContainer.innerHTML = '';
        const teamError = document.createElement('div');
        teamError.className = 'p-6 text-center text-gray-500 dark:text-gray-400';
        const teamErrorText = document.createElement('p');
        teamErrorText.textContent = 'Failed to load team data';
        const teamRetryBtn = document.createElement('button');
        teamRetryBtn.className = 'mt-2 text-blue-600 dark:text-blue-400 hover:underline';
        teamRetryBtn.textContent = 'Try again';
        teamRetryBtn.onclick = refreshData;
        teamError.appendChild(teamErrorText);
        teamError.appendChild(teamRetryBtn);
        teamContainer.appendChild(teamError);
      }
    }

    function refreshData() {
      const refreshBtn = document.getElementById('refresh-btn');
      const refreshIcon = document.getElementById('refresh-icon');
      
      refreshBtn.disabled = true;
      refreshIcon.classList.add('rotate');
      
      fetchUserData().finally(() => {
        setTimeout(() => {
          refreshBtn.disabled = false;
          refreshIcon.classList.remove('rotate');
        }, 500);
      });
    }

    async function claimRewards() {
      const email = localStorage.getItem('email');
      
      if (!email) {
        showToast('Email not found', 'error');
        return;
      }

      const claimBtn = document.getElementById('claim-btn');
      const claimBtnText = document.getElementById('claim-btn-text');
      
      claimBtn.disabled = true;
      claimBtnText.textContent = 'Claiming...';

      try {
        const response = await fetch(`${API_BASE}/api/rewards/claim`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email }),
        });

        if (!response.ok) {
          throw new Error('Failed to claim rewards');
        }

        const data = await response.json();
        showToast(`Successfully claimed $${data.claimedAmount}!`, 'success');
        
        setTimeout(() => {
          refreshData();
        }, 1000);

      } catch (error) {
        console.error('Error claiming rewards:', error);
        showToast('Failed to claim rewards. Please try again.', 'error');
        claimBtn.disabled = false;
        claimBtnText.textContent = 'Claim Rewards';
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      fetchUserData();
    });
  </script>
</body>
</html>
